<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAMHANGA GROUP 2014-2018üåç - Mfumo wa Usimamizi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a5276;
            --secondary-color: #2980b9;
            --accent-color: #f39c12;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            background-color: var(--secondary-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        nav ul li {
            flex: 1;
        }
        
        nav ul li a {
            display: block;
            color: var(--white);
            text-decoration: none;
            padding: 12px 15px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: var(--accent-color);
        }
        
        .section {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px 0;
        }
        
        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 10px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        .form-group i {
            position: absolute;
            left: 10px;
            top: 38px;
            color: var(--secondary-color);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-warning {
            background-color: var(--accent-color);
        }
        
        table.vertical-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table.vertical-table th {
            background-color: var(--light-bg);
            padding: 12px 15px;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            text-align: left;
        }
        
        table.vertical-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            display: block;
            width: 100%;
        }
        
        table.vertical-table tr {
            display: block;
            margin-bottom: 15px;
            background-color: var(--white);
        }
        
        table.vertical-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
        }
        
        .dashboard-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .dashboard-card .value {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .dashboard-card .label {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
        }
        
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        
        .tabs {
            display: flex;
            background-color: var(--light-bg);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .tab-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            nav ul { flex-direction: column; }
            .dashboard-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <h3>Ingia kama Admin</h3>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="admin-password" placeholder="Ingiza Password">
            </div>
            <button class="btn" onclick="loginAsAdmin()">Ingia</button>
            <button class="btn btn-danger" onclick="closeModal('admin-login-modal')">Funga</button>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="logo">KAMHANGA GROUP 2014-2018üìöüìùüìñ</div>
            <nav>
                <ul>
                    <li><a href="#" class="active" onclick="showSection('dashboard')">NYUMBANIüè†</a></li>
                    <li><a href="#" onclick="showSection('members')">WANACHAMA üë≠</a></li>
                    <li><a href="#" onclick="showSection('payments')">MALIPOüóûÔ∏è</a></li>
                    <li><a href="#" onclick="showSection('expenses')">MATUMIZI ‚õΩ</a></li>
                    <li><a href="#" onclick="showSection('elections')">UCHANGUZI üó≥Ô∏è</a></li>
                    <li><a href="#" onclick="showSection('reports')">HALI YA WANACHAMA üìÜ</a></li>
                    <li><a href="#" onclick="showModal('admin-login-modal')">KWA MATUMIZI YA VIONGOZI PEKEEüîè</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <div id="payment-password-modal" class="modal">
        <div class="modal-content">
            <h3>Ingiza Password ya Malipo</h3>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="payment-password" placeholder="Password">
            </div>
            <button class="btn" onclick="verifyPaymentPassword()">Thibitisha</button>
            <button class="btn btn-danger" onclick="closeModal('payment-password-modal')">Funga</button>
        </div>
    </div>

    <div id="expense-password-modal" class="modal">
        <div class="modal-content">
            <h3>Ingiza Password ya Matumizi</h3>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="expense-password" placeholder="Password">
            </div>
            <button class="btn" onclick="verifyExpensePassword()">Thibitisha</button>
            <button class="btn btn-danger" onclick="closeModal('expense-password-modal')">Funga</button>
        </div>
    </div>

    <div id="delete-password-modal" class="modal">
        <div class="modal-content">
            <h3>Ingiza Password ya Kufuta</h3>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="delete-password" placeholder="Password">
            </div>
            <button class="btn" onclick="verifyDeletePassword()">Thibitisha</button>
            <button class="btn btn-danger" onclick="closeModal('delete-password-modal')">Funga</button>
        </div>
    </div>

    <div id="admin-settings-modal" class="modal">
        <div class="modal-content">
            <h3>Mipangilio ya Admin</h3>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-admin-password" placeholder="Password Mpya ya Admin">
            </div>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-delete-password" placeholder="Password Mpya ya Kufuta">
            </div>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-expense-password" placeholder="Password Mpya ya Matumizi">
            </div>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-payment-password" placeholder="Password Mpya ya Malipo">
            </div>
            <div class="form-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="new-system-password" placeholder="Password Mpya ya Mfumo Mzima">
            </div>
            <button class="btn" onclick="updatePasswords()">Hifadhi Mabadiliko</button>
            <button class="btn btn-danger" onclick="closeModal('admin-settings-modal')">Funga</button>
        </div>
    </div>

    <div class="container">
        <div id="dashboard" class="section">
            <h2>NYUMBANIüè†</h2>
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3>Jumla ya Wanachama</h3>
                    <div class="value" id="total-members">0</div>
                    <div class="label">Wanachama</div>
                </div>
                <div class="dashboard-card">
                    <h3>Jumla ya Mapato</h3>
                    <div class="value" id="total-income">0</div>
                    <div class="label">TZS</div>
                </div>
                <div class="dashboard-card">
                    <h3>Jumla ya Matumizi</h3>
                    <div class="value" id="total-expenses">0</div>
                    <div class="label">TZS</div>
                </div>
                <div class="dashboard-card">
                    <h3>Salio</h3>
                    <div class="value" id="balance">0</div>
                    <div class="label">TZS</div>
                </div>
            </div>
            <h2>Chati ya Mapato na Matumizi</h2>
            <div class="chart-container" id="income-expense-chart"></div>
            <h2>Shughuli za Hivi Karibuni</h2>
            <table class="vertical-table">
                <thead><tr><th>Shughuli za Hivi Karibuni</th></tr></thead>
                <tbody id="recent-activities"></tbody>
            </table>
        </div>
        
        <div id="members" class="section" style="display:none">
            <h2>Usajili wa Wanachama</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('new-member', this)">Sajili Mwanachama Mpya</button>
                <button class="tab-btn" onclick="switchTab('members-list', this)">Orodha ya Wanachama</button>
            </div>
            <div id="new-member" class="tab-content active">
                <form id="member-form" onsubmit="addMember(event)">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="fullname" placeholder="Jina Kamili" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="phone" placeholder="Namba ya Simu" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="address" placeholder="Anwani" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-calendar"></i>
                        <input type="date" id="join-date" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-briefcase"></i>
                        <select id="position">
                            <option value="">Hakuna</option>
                            <option value="chairman">Mwenyekiti</option>
                            <option value="secretary">Katibu</option>
                            <option value="treasurer">Mweka Hazina</option>
                            <option value="member">Mwanachama wa Kawaida</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-coins"></i>
                        <input type="number" id="entry-fee" placeholder="Kiingilio (TZS)" required>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Sajili Mwanachama</button>
                </form>
            </div>
            <div id="members-list" class="tab-content">
                <input type="text" id="search-member" placeholder="Tafuta mwanachama..." onkeyup="searchMembers()">
                <table class="vertical-table">
                    <thead><tr><th>Orodha ya Wanachama</th></tr></thead>
                    <tbody id="members-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="payments" class="section" style="display:none">
            <h2>Usimamizi wa Malipo</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('new-payment', this)">Malipo Mapya</button>
                <button class="tab-btn" onclick="switchTab('payments-list', this)">Orodha ya Malipo</button>
            </div>
            <div id="new-payment" class="tab-content active">
                <form id="payment-form" onsubmit="event.preventDefault(); showModal('payment-password-modal')">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <select id="payment-member" required>
                            <option value="">Chagua Mwanachama</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-money-bill"></i>
                        <select id="payment-type" required>
                            <option value="">Chagua Aina</option>
                            <option value="entry">Kiingilio</option>
                            <option value="monthly">Ada ya Mwezi</option>
                            <option value="disaster">Mchango wa Maafa</option>
                            <option value="other">Nyingine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-coins"></i>
                        <input type="number" id="payment-amount" placeholder="Kiasi (TZS)" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-calendar"></i>
                        <input type="date" id="payment-date" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-comment"></i>
                        <textarea id="payment-description" rows="3" placeholder="Maelezo"></textarea>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Rekodi Malipo</button>
                </form>
            </div>
            <div id="payments-list" class="tab-content">
                <div class="form-group">
                    <label for="payment-filter">Chuja kwa Aina</label>
                    <select id="payment-filter" onchange="filterPayments()">
                        <option value="all">Zote</option>
                        <option value="entry">Kiingilio</option>
                        <option value="monthly">Ada ya Mwezi</option>
                        <option value="disaster">Mchango wa Maafa</option>
                        <option value="other">Nyingine</option>
                    </select>
                </div>
                <table class="vertical-table">
                    <thead><tr><th>Orodha ya Malipo</th></tr></thead>
                    <tbody id="payments-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="expenses" class="section" style="display:none">
            <h2>Usimamizi wa Matumizi</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('new-expense', this)">Matumizi Mapya</button>
                <button class="tab-btn" onclick="switchTab('expenses-list', this)">Orodha ya Matumizi</button>
            </div>
            <div id="new-expense" class="tab-content active">
                <form id="expense-form" onsubmit="event.preventDefault(); showModal('expense-password-modal')">
                    <div class="form-group">
                        <i class="fas fa-money-bill"></i>
                        <select id="expense-type" required>
                            <option value="">Chagua Aina</option>
                            <option value="daily">Matumizi ya Siku</option>
                            <option value="weekly">Matumizi ya Wiki</option>
                            <option value="monthly">Matumizi ya Mwezi</option>
                            <option value="yearly">Matumizi ya Mwaka</option>
                            <option value="other">Nyingine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-coins"></i>
                        <input type="number" id="expense-amount" placeholder="Kiasi (TZS)" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-calendar"></i>
                        <input type="date" id="expense-date" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-comment"></i>
                        <textarea id="expense-description" rows="3" placeholder="Maelezo"></textarea>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Rekodi Matumizi</button>
                </form>
            </div>
            <div id="expenses-list" class="tab-content">
                <div class="form-group">
                    <label for="expense-filter">Chuja kwa Aina</label>
                    <select id="expense-filter" onchange="filterExpenses()">
                        <option value="all">Zote</option>
                        <option value="daily">Siku</option>
                        <option value="weekly">Wiki</option>
                        <option value="monthly">Mwezi</option>
                        <option value="yearly">Mwaka</option>
                        <option value="other">Nyingine</option>
                    </select>
                </div>
                <table class="vertical-table">
                    <thead><tr><th>Orodha ya Matumizi</th></tr></thead>
                    <tbody id="expenses-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="elections" class="section" style="display:none">
            <h2>Usimamizi wa Uchaguzi</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('new-election', this)">Uchaguzi Mpya</button>
                <button class="tab-btn" onclick="switchTab('elections-list', this)">Orodha ya Uchaguzi</button>
            </div>
            <div id="new-election" class="tab-content active">
                <form id="election-form" onsubmit="createElection(event)">
                    <div class="form-group">
                        <i class="fas fa-vote-yea"></i>
                        <input type="text" id="election-title" placeholder="Kichwa cha Uchaguzi" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-briefcase"></i>
                        <select id="election-position" required>
                            <option value="">Chagua Wadhifa</option>
                            <option value="chairman">Mwenyekiti</option>
                            <option value="secretary">Katibu</option>
                            <option value="treasurer">Mweka Hazina</option>
                            <option value="other">Nyingine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-calendar"></i>
                        <input type="date" id="election-date" required>
                    </div>
                    <div class="form-group">
                        <i class="fas fa-comment"></i>
                        <textarea id="election-description" rows="3" placeholder="Maelezo"></textarea>
                    </div>
                    <div id="candidates-container">
                        <h3>Wagombea</h3>
                        <div class="candidate-item">
                            <select class="candidate-select" required>
                                <option value="">Chagua Mgombea</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-warning" onclick="addCandidateField()">Ongeza Mgombea</button>
                    <button type="submit" class="btn"><i class="fas fa-save"></i> Anzisha Uchaguzi</button>
                </form>
            </div>
            <div id="elections-list" class="tab-content">
                <table class="vertical-table">
                    <thead><tr><th>Orodha ya Uchaguzi</th></tr></thead>
                    <tbody id="elections-table"></tbody>
                </table>
            </div>
        </div>
        
        <div id="reports" class="section" style="display:none">
            <h2>Ripoti na Takwimu</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('financial-reports', this)">Ripoti za Kifedha</button>
                <button class="tab-btn" onclick="switchTab('attendance-reports', this)">Mahudhurio</button>
                <button class="tab-btn" onclick="switchTab('member-reports', this)">Ripoti za Wanachama</button>
            </div>
            <div id="financial-reports" class="tab-content active">
                <div class="form-group">
                    <label for="financial-period">Kipindi</label>
                    <select id="financial-period" onchange="generateFinancialReport()">
                        <option value="daily">Siku</option>
                        <option value="weekly">Wiki</option>
                        <option value="this-month">Mwezi Huu</option>
                        <option value="last-month">Mwezi Uliopita</option>
                        <option value="this-year">Mwaka Huu</option>
                        <option value="custom">Kipindi Maalum</option>
                    </select>
                </div>
                <div id="custom-date-range" style="display:none">
                    <div class="form-group">
                        <label for="start-date">Tarehe ya Kuanza</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="form-group">
                        <label for="end-date">Tarehe ya Kumaliza</label>
                        <input type="date" id="end-date">
                    </div>
                    <button class="btn" onclick="generateFinancialReport()">Jana Ripoti</button>
                </div>
                <div class="chart-container" id="financial-chart"></div>
                <h3>Muhtasari wa Fedha</h3>
                <table class="vertical-table">
                    <thead><tr><th>Muhtasari wa Fedha</th></tr></thead>
                    <tbody id="financial-summary"></tbody>
                </table>
                <button class="btn" onclick="printFinancialReport()">Chapisha Ripoti</button>
            </div>
            <div id="attendance-reports" class="tab-content">
                <div class="form-group">
                    <label for="attendance-period">Kipindi</label>
                    <select id="attendance-period" onchange="generateAttendanceReport()">
                        <option value="this-month">Mwezi Huu</option>
                        <option value="last-month">Mwezi Uliopita</option>
                        <option value="this-year">Mwaka Huu</option>
                    </select>
                </div>
                <div class="chart-container" id="attendance-chart"></div>
                <table class="vertical-table">
                    <thead><tr><th>Muhtasari wa Mahudhurio</th></tr></thead>
                    <tbody id="attendance-summary"></tbody>
                </table>
                <button class="btn" onclick="printAttendanceReport()">Chapisha Ripoti</button>
            </div>
            <div id="member-reports" class="tab-content">
                <div class="form-group">
                    <label for="member-report-type">Aina ya Ripoti</label>
                    <select id="member-report-type" onchange="generateMemberReport()">
                        <option value="active">Wanachama Wanaofanya Kazi</option>
                        <option value="inactive">Wanachama Wasio na Shughuli</option>
                        <option value="new">Wanachama Wapya (Miezi 3 iliyopita)</option>
                        <option value="fee-status">Hali ya Malipo ya Ada</option>
                    </select>
                </div>
                <table class="vertical-table">
                    <thead><tr><th>Ripoti ya Wanachama</th></tr></thead>
                    <tbody id="member-report-summary"></tbody>
                </table>
                <button class="btn" onclick="printMemberReport()">Chapisha Ripoti</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD0jEZJ6xXAeOApIl5h0MOuRfe4Js2qjQw",
            authDomain: "kamhanga-group.firebaseapp.com",
            databaseURL: "https://kamhanga-group-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kamhanga-group",
            storageBucket: "kamhanga-group.firebasestorage.app",
            messagingSenderId: "95627779972",
            appId: "1:95627779972:web:1aa4118d23d05cd959c7d1",
            measurementId: "G-FTBFB9SXT6"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        db.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                console.log("Connected to Realtime Database (online mode)");
            } else {
                console.log("Disconnected from Realtime Database (offline mode)");
            }
        });

        let passwords = {
            admin: '1340',
            payment: '1340',
            expense: '1340',
            delete: '1340'
        };
        
        let isAdmin = false;
        let pendingAction = null;

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function loginAsAdmin() {
            const password = document.getElementById('admin-password').value;
            if (password === passwords.admin) {
                isAdmin = true;
                closeModal('admin-login-modal');
                showModal('admin-settings-modal');
            } else {
                alert('Password ya Admin si sahihi!');
            }
            document.getElementById('admin-password').value = '';
        }

        function verifyPaymentPassword() {
            const password = document.getElementById('payment-password').value;
            if (password === passwords.payment) {
                closeModal('payment-password-modal');
                addPayment();
            } else {
                alert('Password ya Malipo si sahihi!');
            }
            document.getElementById('payment-password').value = '';
        }

        function verifyExpensePassword() {
            const password = document.getElementById('expense-password').value;
            if (password === passwords.expense) {
                closeModal('expense-password-modal');
                addExpense();
            } else {
                alert('Password ya Matumizi si sahihi!');
            }
            document.getElementById('expense-password').value = '';
        }

        function verifyDeletePassword() {
            const password = document.getElementById('delete-password').value;
            if (password === passwords.delete) {
                closeModal('delete-password-modal');
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                alert('Password ya Kufuta si sahihi!');
            }
            document.getElementById('delete-password').value = '';
        }

        function updatePasswords() {
            const newAdmin = document.getElementById('new-admin-password').value;
            const newDelete = document.getElementById('new-delete-password').value;
            const newExpense = document.getElementById('new-expense-password').value;
            const newPayment = document.getElementById('new-payment-password').value;
            const newSystem = document.getElementById('new-system-password').value;

            if (newSystem) {
                passwords = {
                    admin: newSystem,
                    payment: newSystem,
                    expense: newSystem,
                    delete: newSystem
                };
            } else {
                if (newAdmin) passwords.admin = newAdmin;
                if (newDelete) passwords.delete = newDelete;
                if (newExpense) passwords.expense = newExpense;
                if (newPayment) passwords.payment = newPayment;
            }

            alert('Passwords zimebadilishwa kwa mafanikio!');
            closeModal('admin-settings-modal');
            document.querySelectorAll('#admin-settings-modal input').forEach(input => input.value = '');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
            }
            
            document.querySelectorAll('nav ul li a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(sectionId)) {
                    link.classList.add('active');
                }
            });
            
            if (sectionId === 'dashboard') loadDashboard();
            else if (sectionId === 'members') loadMembers();
            else if (sectionId === 'payments') {
                loadPayments();
                populateMembersDropdown('payment-member');
            } else if (sectionId === 'expenses') {
                loadExpenses();
            } else if (sectionId === 'elections') {
                loadElections();
                populateMembersDropdown('candidate-select');
            } else if (sectionId === 'reports') generateFinancialReport();
        }
        
        function switchTab(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
        
        function addMember(event) {
            event.preventDefault();
            const member = {
                id: Date.now().toString(),
                fullname: document.getElementById('fullname').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                joinDate: document.getElementById('join-date').value,
                position: document.getElementById('position').value,
                entryFee: parseFloat(document.getElementById('entry-fee').value)
            };
            
            db.ref('members/' + member.id).set(member)
                .then(() => {
                    document.getElementById('member-form').reset();
                    alert('Mwanachama amesajiliwa!');
                    loadMembers();
                })
                .catch(error => {
                    console.error('Error adding member:', error);
                    alert('Hitilafu imetokea wakati wa kusajili mwanachama: ' + error.message);
                });
        }
        
        function loadMembers() {
            db.ref('members').once('value', (snapshot) => {
                const members = snapshot.val() ? Object.values(snapshot.val()) : [];
                const tbody = document.getElementById('members-table');
                tbody.innerHTML = '';
                members.forEach(member => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>ID: ${member.id}</td>
                        <td>Jina Kamili: ${member.fullname}</td>
                        <td>Namba ya Simu: ${member.phone}</td>
                        <td>Anwani: ${member.address}</td>
                        <td>Tarehe ya Kujiunga: ${member.joinDate}</td>
                        <td>Wadhifa: ${member.position || 'Hakuna'}</td>
                        <td><button class="btn btn-danger" onclick="deleteMember('${member.id}')">Futa</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }, (error) => {
                console.error('Error loading members:', error);
                alert('Hitilafu imetokea wakati wa kupakia wanachama: ' + error.message);
            });
        }
        
        function deleteMember(id) {
            pendingAction = () => {
                db.ref('members/' + id).remove()
                    .then(() => loadMembers())
                    .catch(error => {
                        console.error('Error deleting member:', error);
                        alert('Hitilafu imetokea wakati wa kufuta mwanachama: ' + error.message);
                    });
            };
            showModal('delete-password-modal');
        }
        
        function searchMembers() {
            const search = document.getElementById('search-member').value.toLowerCase();
            db.ref('members').once('value', (snapshot) => {
                const members = snapshot.val() ? Object.values(snapshot.val()) : [];
                const filtered = members.filter(m => m.fullname.toLowerCase().includes(search));
                const tbody = document.getElementById('members-table');
                tbody.innerHTML = '';
                filtered.forEach(member => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>ID: ${member.id}</td>
                        <td>Jina Kamili: ${member.fullname}</td>
                        <td>Namba ya Simu: ${member.phone}</td>
                        <td>Anwani: ${member.address}</td>
                        <td>Tarehe ya Kujiunga: ${member.joinDate}</td>
                        <td>Wadhifa: ${member.position || 'Hakuna'}</td>
           <td><button class="btn btn-danger" onclick="deleteMember('${member.id}')">Futa</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }, (error) => {
                console.error('Error searching members:', error);
                alert('Hitilafu imetokea wakati wa kutafuta wanachama: ' + error.message);
            });
        }
        
        function addPayment() {
            const payment = {
                id: Date.now().toString(),
                memberId: document.getElementById('payment-member').value,
                type: document.getElementById('payment-type').value,
                amount: parseFloat(document.getElementById('payment-amount').value),
                date: document.getElementById('payment-date').value,
                description: document.getElementById('payment-description').value
            };
            
            db.ref('payments/' + payment.id).set(payment)
                .then(() => {
                    document.getElementById('payment-form').reset();
                    alert('Malipo yamehifadhiwa!');
                    loadPayments();
                })
                .catch(error => {
                    console.error('Error adding payment:', error);
                    alert('Hitilafu imetokea wakati wa kuhifadhi malipo: ' + error.message);
                });
        }
        
        function loadPayments() {
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('payments').orderByChild('date').once('value', (paymentsSnapshot) => {
                    const payments = paymentsSnapshot.val() ? Object.values(paymentsSnapshot.val()) : [];
                    const tbody = document.getElementById('payments-table');
                    tbody.innerHTML = '';
                    payments.forEach(payment => {
                        const member = members.find(m => m.id === payment.memberId);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>ID: ${payment.id}</td>
                            <td>Mwanachama: ${member ? member.fullname : 'Haijulikani'}</td>
                            <td>Aina: ${payment.type}</td>
                            <td>Kiasi: ${payment.amount.toLocaleString()} TZS</td>
                            <td>Tarehe: ${payment.date}</td>
                            <td>Maelezo: ${payment.description || '-'}</td>
                            <td><button class="btn btn-danger" onclick="deletePayment('${payment.id}')">Futa</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }).catch(error => {
                console.error('Error loading payments:', error);
                alert('Hitilafu imetokea wakati wa kupakia malipo: ' + error.message);
            });
        }
        
        function deletePayment(id) {
            pendingAction = () => {
                db.ref('payments/' + id).remove()
                    .then(() => loadPayments())
                    .catch(error => {
                        console.error('Error deleting payment:', error);
                        alert('Hitilafu imetokea wakati wa kufuta malipo: ' + error.message);
                    });
            };
            showModal('delete-password-modal');
        }
        
        function filterPayments() {
            const filter = document.getElementById('payment-filter').value;
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('payments').orderByChild('date').once('value', (paymentsSnapshot) => {
                    const payments = paymentsSnapshot.val() ? Object.values(paymentsSnapshot.val()) : [];
                    const filtered = filter === 'all' ? payments : payments.filter(p => p.type === filter);
                    const tbody = document.getElementById('payments-table');
                    tbody.innerHTML = '';
                    filtered.forEach(payment => {
                        const member = members.find(m => m.id === payment.memberId);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>ID: ${payment.id}</td>
                            <td>Mwanachama: ${member ? member.fullname : 'Haijulikani'}</td>
                            <td>Aina: ${payment.type}</td>
                            <td>Kiasi: ${payment.amount.toLocaleString()} TZS</td>
                            <td>Tarehe: ${payment.date}</td>
                            <td>Maelezo: ${payment.description || '-'}</td>
                            <td><button class="btn btn-danger" onclick="deletePayment('${payment.id}')">Futa</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }).catch(error => {
                console.error('Error filtering payments:', error);
                alert('Hitilafu imetokea wakati wa kuchuja malipo: ' + error.message);
            });
        }
        
        function populateMembersDropdown(selectId) {
            db.ref('members').once('value', (snapshot) => {
                const members = snapshot.val() ? Object.values(snapshot.val()) : [];
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Chagua Mwanachama</option>';
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.fullname;
                        select.appendChild(option);
                    });
                }
                document.querySelectorAll('.candidate-select').forEach(select => {
                    select.innerHTML = '<option value="">Chagua Mgombea</option>';
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = member.fullname;
                        select.appendChild(option);
                    });
                });
            }).catch(error => {
                console.error('Error populating members dropdown:', error);
                alert('Hitilafu imetokea wakati wa kupakia orodha ya wanachama: ' + error.message);
            });
        }
        
        function addExpense() {
            const expense = {
                id: Date.now().toString(),
                type: document.getElementById('expense-type').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: document.getElementById('expense-date').value,
                description: document.getElementById('expense-description').value
            };
            
            db.ref('expenses/' + expense.id).set(expense)
                .then(() => {
                    document.getElementById('expense-form').reset();
                    alert('Matumizi yamehifadhiwa!');
                    loadExpenses();
                })
                .catch(error => {
                    console.error('Error adding expense:', error);
                    alert('Hitilafu imetokea wakati wa kuhifadhi matumizi: ' + error.message);
                });
        }
        
        function loadExpenses() {
            db.ref('expenses').orderByChild('date').once('value', (snapshot) => {
                const expenses = snapshot.val() ? Object.values(snapshot.val()) : [];
                const tbody = document.getElementById('expenses-table');
                tbody.innerHTML = '';
                expenses.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>ID: ${expense.id}</td>
                        <td>Aina: ${expense.type}</td>
                        <td>Kiasi: ${expense.amount.toLocaleString()} TZS</td>
                        <td>Tarehe: ${expense.date}</td>
                        <td>Maelezo: ${expense.description || '-'}</td>
                        <td><button class="btn btn-danger" onclick="deleteExpense('${expense.id}')">Futa</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }).catch(error => {
                console.error('Error loading expenses:', error);
                alert('Hitilafu imetokea wakati wa kupakia matumizi: ' + error.message);
            });
        }
        
        function deleteExpense(id) {
            pendingAction = () => {
                db.ref('expenses/' + id).remove()
                    .then(() => loadExpenses())
                    .catch(error => {
                        console.error('Error deleting expense:', error);
                        alert('Hitilafu imetokea wakati wa kufuta matumizi: ' + error.message);
                    });
            };
            showModal('delete-password-modal');
        }
        
        function filterExpenses() {
            const filter = document.getElementById('expense-filter').value;
            db.ref('expenses').orderByChild('date').once('value', (snapshot) => {
                const expenses = snapshot.val() ? Object.values(snapshot.val()) : [];
                const filtered = filter === 'all' ? expenses : expenses.filter(e => e.type === filter);
                const tbody = document.getElementById('expenses-table');
                tbody.innerHTML = '';
                filtered.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>ID: ${expense.id}</td>
                        <td>Aina: ${expense.type}</td>
                        <td>Kiasi: ${expense.amount.toLocaleString()} TZS</td>
                        <td>Tarehe: ${expense.date}</td>
                        <td>Maelezo: ${expense.description || '-'}</td>
                        <td><button class="btn btn-danger" onclick="deleteExpense('${expense.id}')">Futa</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }).catch(error => {
                console.error('Error filtering expenses:', error);
                alert('Hitilafu imetokea wakati wa kuchuja matumizi: ' + error.message);
            });
        }
        
        function createElection(event) {
            event.preventDefault();
            const candidates = Array.from(document.querySelectorAll('.candidate-select'))
                .map(select => select.value)
                .filter(value => value !== '');
            
            const election = {
                id: Date.now().toString(),
                title: document.getElementById('election-title').value,
                position: document.getElementById('election-position').value,
                date: document.getElementById('election-date').value,
                description: document.getElementById('election-description').value,
                candidates: candidates,
                status: 'Pending',
                winner: null
            };
            
            db.ref('elections/' + election.id).set(election)
                .then(() => {
                    document.getElementById('election-form').reset();
                    alert('Uchaguzi umeanzishwa!');
                    loadElections();
                })
                .catch(error => {
                    console.error('Error creating election:', error);
                    alert('Hitilafu imetokea wakati wa kuanzisha uchaguzi: ' + error.message);
                });
        }
        
        function addCandidateField() {
            const container = document.getElementById('candidates-container');
            const div = document.createElement('div');
            div.className = 'candidate-item';
            div.innerHTML = `
                <select class="candidate-select" required>
                    <option value="">Chagua Mgombea</option>
                </select>
                <button class="btn btn-danger" onclick="this.parentElement.remove()">Futa</button>
            `;
            container.appendChild(div);
            populateMembersDropdown('candidate-select');
        }
        
        function loadElections() {
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('elections').once('value', (electionsSnapshot) => {
                    const elections = electionsSnapshot.val() ? Object.values(electionsSnapshot.val()) : [];
                    const tbody = document.getElementById('elections-table');
                    tbody.innerHTML = '';
                    elections.forEach(election => {
                        const winner = election.winner ? members.find(m => m.id === election.winner)?.fullname : '-';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>ID: ${election.id}</td>
                            <td>Kichwa: ${election.title}</td>
                            <td>Wadhifa: ${election.position}</td>
                            <td>Tarehe: ${election.date}</td>
                            <td>Hali: ${election.status}</td>
                            <td>Mshindi: ${winner}</td>
                            <td>
                                <button class="btn btn-success" onclick="declareWinner('${election.id}')">Taja Mshindi</button>
                                <button class="btn btn-danger" onclick="deleteElection('${election.id}')">Futa</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }).catch(error => {
                console.error('Error loading elections:', error);
                alert('Hitilafu imetokea wakati wa kupakia uchaguzi: ' + error.message);
            });
        }
        
        function deleteElection(id) {
            pendingAction = () => {
                db.ref('elections/' + id).remove()
                    .then(() => loadElections())
                    .catch(error => {
                        console.error('Error deleting election:', error);
                        alert('Hitilafu imetokea wakati wa kufuta uchaguzi: ' + error.message);
                    });
            };
            showModal('delete-password-modal');
        }
        
        function declareWinner(electionId) {
            db.ref('elections/' + electionId).once('value', (snapshot) => {
                const election = snapshot.val();
                const winnerId = prompt('Ingiza ID ya Mshindi:');
                if (winnerId && election.candidates.includes(winnerId)) {
                    db.ref('elections/' + electionId).update({
                        status: 'Completed',
                        winner: winnerId
                    }).then(() => {
                        loadElections();
                        alert('Mshindi ametangazwa!');
                    }).catch(error => {
                        console.error('Error declaring winner:', error);
                        alert('Hitilafu imetokea wakati wa kutangaza mshindi: ' + error.message);
                    });
                } else {
                    alert('ID ya Mshindi haipatikani au haiko kwenye orodha ya wagombea!');
                }
            }).catch(error => {
                console.error('Error retrieving election:', error);
                alert('Hitilafu imetokea wakati wa kupata uchaguzi: ' + error.message);
            });
        }
        
        function loadDashboard() {
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('payments').once('value', (paymentsSnapshot) => {
                    const payments = paymentsSnapshot.val() ? Object.values(paymentsSnapshot.val()) : [];
                    db.ref('expenses').once('value', (expensesSnapshot) => {
                        const expenses = expensesSnapshot.val() ? Object.values(expensesSnapshot.val()) : [];
                        
                        let totalIncome = payments.reduce((sum, p) => sum + p.amount, 0);
                        let totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                        
                        document.getElementById('total-members').textContent = members.length;
                        document.getElementById('total-income').textContent = totalIncome.toLocaleString();
                        document.getElementById('total-expenses').textContent = totalExpenses.toLocaleString();
                        document.getElementById('balance').textContent = (totalIncome - totalExpenses).toLocaleString();
                        
                        createIncomeExpenseChart(payments, expenses);
                        loadRecentActivities(payments, expenses);
                    });
                });
            }).catch(error => {
                console.error('Error loading dashboard:', error);
                alert('Hitilafu imetokea wakati wa kupakia dashbodi: ' + error.message);
            });
        }
        
        function createIncomeExpenseChart(payments, expenses) {
            const lastSixMonths = getLastSixMonths();
            const incomeData = Array(6).fill(0);
            const expenseData = Array(6).fill(0);
            
            payments.forEach(payment => {
                const paymentDate = new Date(payment.date);
                const monthYear = `${paymentDate.getMonth() + 1}/${paymentDate.getFullYear()}`;
                const monthIndex = lastSixMonths.findIndex(m => m.value === monthYear);
                if (monthIndex !== -1) {
                    incomeData[monthIndex] += payment.amount;
                }
            });
            
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                const monthYear = `${expenseDate.getMonth() + 1}/${expenseDate.getFullYear()}`;
                const monthIndex = lastSixMonths.findIndex(m => m.value === monthYear);
                if (monthIndex !== -1) {
                    expenseData[monthIndex] += expense.amount;
                }
            });
            
            const ctx = document.createElement('canvas');
            document.getElementById('income-expense-chart').innerHTML = '';
            document.getElementById('income-expense-chart').appendChild(ctx);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lastSixMonths.map(m => m.label),
                    datasets: [
                        { label: 'Mapato', data: incomeData, backgroundColor: '#27ae60' },
                        { label: 'Matumizi', data: expenseData, backgroundColor: '#e74c3c' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Kiasi (TZS)' } },
                        x: { title: { display: true, text: 'Mwezi' } }
                    }
                }
            });
        }
        
        function getLastSixMonths() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = month.toLocaleString('sw', { month: 'short' });
                const year = month.getFullYear();
                months.push({ label: `${monthName} ${year}`, value: `${month.getMonth() + 1}/${year}` });
            }
            return months;
        }
        
        function loadRecentActivities(payments, expenses) {
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                const allTransactions = [
                    ...payments.map(p => ({...p, isPayment: true})),
                    ...expenses.map(e => ({...e, isPayment: false}))
                ].sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
                
                const tbody = document.getElementById('recent-activities');
                tbody.innerHTML = '';
                allTransactions.forEach(transaction => {
                    const member = transaction.isPayment ? members.find(m => m.id === transaction.memberId) : null;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>Tarehe: ${transaction.date}</td>
                        <td>Shughuli: ${transaction.isPayment ? 'Malipo' : 'Matumizi'}</td>
                        <td>Maelezo: ${transaction.isPayment ? (member ? member.fullname : 'Haijulikani') : ''} - ${transaction.description || '-'}</td>
                        <td>Kiasi: ${transaction.amount.toLocaleString()} TZS</td>
                    `;
                    tbody.appendChild(tr);
                });
            }).catch(error => {
                console.error('Error loading recent activities:', error);
                alert('Hitilafu imetokea wakati wa kupakia shughuli za hivi karibuni: ' + error.message);
            });
        }
        
        function generateFinancialReport() {
            const period = document.getElementById('financial-period').value;
            db.ref('payments').once('value', (paymentsSnapshot) => {
                const payments = paymentsSnapshot.val() ? Object.values(paymentsSnapshot.val()) : [];
                db.ref('expenses').once('value', (expensesSnapshot) => {
                    const expenses = expensesSnapshot.val() ? Object.values(expensesSnapshot.val()) : [];
                    let filteredPayments = payments;
                    let filteredExpenses = expenses;
                    const now = new Date();
                    
                    if (period === 'custom') {
                        document.getElementById('custom-date-range').style.display = 'block';
                        const start = new Date(document.getElementById('start-date').value);
                        const end = new Date(document.getElementById('end-date').value);
                        filteredPayments = payments.filter(p => {
                            const date = new Date(p.date);
                            return date >= start && date <= end;
                        });
                        filteredExpenses = expenses.filter(e => {
                            const date = new Date(e.date);
                            return date >= start && date <= end;
                        });
                    } else {
                        document.getElementById('custom-date-range').style.display = 'none';
                        if (period === 'daily') {
                            filteredPayments = payments.filter(p => {
                                const date = new Date(p.date);
                                return date.toDateString() === now.toDateString();
                            });
                            filteredExpenses = expenses.filter(e => {
                                const date = new Date(e.date);
                                return date.toDateString() === now.toDateString();
                            });
                        } else if (period === 'weekly') {
                            const weekAgo = new Date(now);
                            weekAgo.setDate(now.getDate() - 7);
                            filteredPayments = payments.filter(p => new Date(p.date) >= weekAgo);
                            filteredExpenses = expenses.filter(e => new Date(e.date) >= weekAgo);
                        } else if (period === 'this-month') {
                            filteredPayments = payments.filter(p => {
                                const date = new Date(p.date);
                                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                            });
                            filteredExpenses = expenses.filter(e => {
                                const date = new Date(e.date);
                                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                            });
                        } else if (period === 'last-month') {
                            filteredPayments = payments.filter(p => {
                                const date = new Date(p.date);
                                return date.getMonth() === now.getMonth() - 1 && date.getFullYear() === now.getFullYear();
                            });
                            filteredExpenses = expenses.filter(e => {
                                const date = new Date(e.date);
                                return date.getMonth() === now.getMonth() - 1 && date.getFullYear() === now.getFullYear();
                            });
                        } else if (period === 'this-year') {
                            filteredPayments = payments.filter(p => {
                                const date = new Date(p.date);
                                return date.getFullYear() === now.getFullYear();
                            });
                            filteredExpenses = expenses.filter(e => {
                                const date = new Date(e.date);
                                return date.getFullYear() === now.getFullYear();
                            });
                        }
                    }
                    
                    const income = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
                    const expensesTotal = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                    
                    const tbody = document.getElementById('financial-summary');
                    tbody.innerHTML = '';
                    const items = [
                        { label: 'Mapato', value: income.toLocaleString() },
                        { label: 'Matumizi', value: expensesTotal.toLocaleString() },
                        { label: 'Salio', value: (income - expensesTotal).toLocaleString() }
                    ];
                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>Aina: ${item.label}</td>
                            <td>Jumla (TZS): ${item.value}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    const ctx = document.createElement('canvas');
                    document.getElementById('financial-chart').innerHTML = '';
                    document.getElementById('financial-chart').appendChild(ctx);
                    
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Mapato', 'Matumizi'],
                            datasets: [{ data: [income, expensesTotal], backgroundColor: ['#27ae60', '#e74c3c'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                });
            }).catch(error => {
                console.error('Error generating financial report:', error);
                alert('Hitilafu imetokea wakati wa kuunda ripoti ya kifedha: ' + error.message);
            });
        }
        
        function generateAttendanceReport() {
            const period = document.getElementById('attendance-period').value;
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('attendance').once('value', (attendanceSnapshot) => {
                    const attendance = attendanceSnapshot.val() ? Object.values(attendanceSnapshot.val()) : [];
                    const now = new Date();
                    let filteredAttendance = attendance;
                    
                    if (period === 'this-month') {
                        filteredAttendance = attendance.filter(a => {
                            const date = new Date(a.date);
                            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                        });
                    } else if (period === 'last-month') {
                        filteredAttendance = attendance.filter(a => {
                            const date = new Date(a.date);
                            return date.getMonth() === now.getMonth() - 1 && date.getFullYear() === now.getFullYear();
                        });
                    } else if (period === 'this-year') {
                        filteredAttendance = attendance.filter(a => {
                            const date = new Date(a.date);
                            return date.getFullYear() === now.getFullYear();
                        });
                    }
                    
                    const totalMeetings = filteredAttendance.length;
                    const attendanceCount = {};
                    filteredAttendance.forEach(a => {
                        if (a.memberIds) {
                            a.memberIds.forEach(id => {
                                attendanceCount[id] = (attendanceCount[id] || 0) + 1;
                            });
                        }
                    });
                    
                    const tbody = document.getElementById('attendance-summary');
                    tbody.innerHTML = '';
                    members.forEach(member => {
                        const attended = attendanceCount[member.id] || 0;
                        const percentage = totalMeetings > 0 ? (attended / totalMeetings * 100).toFixed(2) : 0;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>Mwanachama: ${member.fullname}</td>
                            <td>Mikutano Aliyohudhuria: ${attended}</td>
                            <td>Jumla ya Mikutano: ${totalMeetings}</td>
                            <td>Asilimia: ${percentage}%</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    const ctx = document.createElement('canvas');
                    document.getElementById('attendance-chart').innerHTML = '';
                    document.getElementById('attendance-chart').appendChild(ctx);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: members.map(m => m.fullname),
                            datasets: [{
                                label: 'Mahudhurio (%)',
                                data: members.map(m => {
                                    const attended = attendanceCount[m.id] || 0;
                                    return totalMeetings > 0 ? (attended / totalMeetings * 100) : 0;
                                }),
                                backgroundColor: '#2980b9'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, max: 100, title: { display: true, text: 'Asilimia ya Mahudhurio' } }
                            }
                        }
                    });
                });
            }).catch(error => {
                console.error('Error generating attendance report:', error);
                alert('Hitilafu imetokea wakati wa kuunda ripoti ya mahudhurio: ' + error.message);
            });
        }
        
        function generateMemberReport() {
            const type = document.getElementById('member-report-type').value;
            db.ref('members').once('value', (membersSnapshot) => {
                const members = membersSnapshot.val() ? Object.values(membersSnapshot.val()) : [];
                db.ref('payments').once('value', (paymentsSnapshot) => {
                    const payments = paymentsSnapshot.val() ? Object.values(paymentsSnapshot.val()) : [];
                    let filteredMembers = members;
                    
                    if (type === 'active') {
                        const activeIds = new Set(payments.map(p => p.memberId));
                        filteredMembers = members.filter(m => activeIds.has(m.id));
                    } else if (type === 'inactive') {
                        const activeIds = new Set(payments.map(p => p.memberId));
                        filteredMembers = members.filter(m => !activeIds.has(m.id));
                    } else if (type === 'new') {
                        const threeMonthsAgo = new Date();
                        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                        filteredMembers = members.filter(m => new Date(m.joinDate) >= threeMonthsAgo);
                    } else if (type === 'fee-status') {
                        filteredMembers = members.map(m => {
                            const memberPayments = payments.filter(p => p.memberId === m.id && p.type === 'monthly');
                            const lastPayment = memberPayments.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                            return {
                                ...m,
                                status: lastPayment && (new Date() - new Date(lastPayment.date)) < 30 * 24 * 60 * 60 * 1000 ? 'Ameanza' : 'Hajaanza'
                            };
                        });
                    }
                    
                    const tbody = document.getElementById('member-report-summary');
                    tbody.innerHTML = '';
                    filteredMembers.forEach(member => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>ID: ${member.id}</td>
                            <td>Jina Kamili: ${member.fullname}</td>
                            <td>Namba ya Simu: ${member.phone}</td>
                            <td>Tarehe ya Kujiunga: ${member.joinDate}</td>
                            <td>Hali: ${member.status || (type === 'active' ? 'Anafanya Kazi' : type === 'inactive' ? 'Hafanyi Kazi' : 'Mpya')}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            }).catch(error => {
                console.error('Error generating member report:', error);
                alert('Hitilafu imetokea wakati wa kuunda ripoti ya wanachama: ' + error.message);
            });
        }
        
        function printFinancialReport() { window.print(); }
        function printAttendanceReport() { window.print(); }
        function printMemberReport() { window.print(); }
        
        window.onload = function() {
            showSection('dashboard');
        };
    </script>
</body>
</html>

        